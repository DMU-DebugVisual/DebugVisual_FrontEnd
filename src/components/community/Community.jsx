import React, { useEffect, useState } from "react";
import { useNavigate } from "react-router-dom";
import "./Community.css";
import config from "../../config";

export default function Community() {
    const navigate = useNavigate();
    const tabs = ["Ï†ÑÏ≤¥", "ÎØ∏Ìï¥Í≤∞", "Ìï¥Í≤∞Îê®"];
    const filters = ["ÏµúÏã†Ïàú", "Ï†ïÌôïÎèÑÏàú", "ÎãµÎ≥ÄÎßéÏùÄÏàú", "Ï¢ãÏïÑÏöîÏàú"];

    // ‚úÖ ÏÑúÎ≤Ñ Îç∞Ïù¥ÌÑ∞ ÏÉÅÌÉú
    const [posts, setPosts] = useState([]);
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState("");

    useEffect(() => {
        let ignore = false;
        const controller = new AbortController();

        (async () => {
            try {
                setLoading(true);
                setError("");

                const token = localStorage.getItem("token");

                // ‚úÖ ÌÜ†ÌÅ∞Ïù¥ ÏûàÏúºÎ©¥ Authorization Ìó§Îçî Ï∂îÍ∞Ä
                const headers = {
                    Accept: "application/json",
                };
                if (token) {
                    headers.Authorization = `Bearer ${token}`;
                }

                const res = await fetch(`${config.API_BASE_URL}/api/posts`, {
                    method: "GET",
                    headers,
                    signal: controller.signal,
                    credentials: "include",
                });

                if (!res.ok) {
                    const text = await res.text();
                    throw new Error(text || `Î™©Î°ù Ï°∞Ìöå Ïã§Ìå® (${res.status})`);
                }

                const data = await res.json(); // ‚Üê Î∞∞Ïó¥ ÌòïÌÉú Í∞ÄÏ†ï
                if (ignore) return;

                // ‚úÖ createdAt(ÎòêÎäî id) Í∏∞Ï§ÄÏúºÎ°ú ÏµúÏã† Í∏ÄÏù¥ Î®ºÏ†Ä Ïò§ÎèÑÎ°ù Ï†ïÎ†¨
                const getTime = (x) => (x ? Date.parse(x) || 0 : 0);
                const sorted = (Array.isArray(data) ? data : [])
                    .slice()
                    .sort((a, b) => {
                        const diff = getTime(b.createdAt) - getTime(a.createdAt);
                        if (diff !== 0) return diff;
                        return (b.id ?? 0) - (a.id ?? 0);
                    });

                // üîÑ Ï†ïÎ†¨Îêú Î™©Î°ùÏùÑ UI ÌïÑÎìúÎ°ú Îß§Ìïë
                const mapped = sorted.map((p) => ({
                    id: p.id,
                    status: p.status || "",
                    title: p.title,
                    summary: (p.content || "").replace(/<[^>]+>/g, "").slice(0, 120),
                    tags: p.tags || [],
                    author: p.writer || "ÏùµÎ™Ö",
                    date: p.createdAt ? new Date(p.createdAt).toLocaleString() : "",
                    likes: p.likeCount ?? 0,
                    comments: p.commentCount ?? 0,
                }));

                setPosts(mapped);
            } catch (e) {
                if (!ignore) setError(e.message || "Ïïå Ïàò ÏóÜÎäî Ïò§Î•ò");
            } finally {
                if (!ignore) setLoading(false);
            }
        })();

        return () => {
            ignore = true;
            controller.abort();
        };
    }, []);

    return (
        <div className="community-wrapper">
            <div className="community-page">
                <aside className="sidebar-left">
                    <h3>Ìï®Íªò Í≥µÎ∂ÄÌï¥Ïöî.</h3>
                    <ul>
                        <li className="active">ÏßàÎ¨∏ & ÎãµÎ≥Ä</li>
                        <li>Í≥†ÎØºÏûàÏñ¥Ïöî</li>
                        <li>Ïä§ÌÑ∞Îîî</li>
                        <li>ÌåÄ ÌîÑÎ°úÏ†ùÌä∏</li>
                        <li>Î∏îÎ°úÍ∑∏</li>
                    </ul>
                    <div className="top-writers">
                        <h4>Zivorp TOP Writers</h4>
                        <ol>
                            <li><span>y2gcoder</span><span>10</span></li>
                            <li><span>durams</span><span>8</span></li>
                            <li><span>David</span><span>7</span></li>
                            <li><span>ÏãùÎπµ</span><span>10</span></li>
                            <li><span>Ïù¥ÏÑ†Ìù¨</span><span>10</span></li>
                            <li><span>Ï∞πÏ∞πÏù¥</span><span>10</span></li>
                            <li><span>Rio song</span><span>10</span></li>
                        </ol>
                    </div>
                </aside>

                <main className="community-main">
                    <div className="tabs">
                        {tabs.map((tab, i) => (
                            <button key={i} className={i === 0 ? "active-tab" : ""}>{tab}</button>
                        ))}
                    </div>

                    <div className="search-bar">
                        <div className="search-row">
                            <input type="text" placeholder="Í∂ÅÍ∏àÌïú ÏßàÎ¨∏ÏùÑ Í≤ÄÏÉâÌï¥Î≥¥ÏÑ∏Ïöî!" />
                            <button className="search-btn">Í≤ÄÏÉâ</button>
                        </div>
                        <div className="search-row">
                            <input type="text" placeholder="# ÌÉúÍ∑∏Î°ú Í≤ÄÏÉâÌï¥Î≥¥ÏÑ∏Ïöî!" />
                            <button className="reset-btn">Ï¥àÍ∏∞Ìôî</button>
                        </div>
                    </div>

                    <div className="filter-area">
                        <div className="filter-bar">
                            {filters.map((filter, i) => (
                                <button key={i} className={i === 0 ? "active" : ""}>{filter}</button>
                            ))}
                        </div>
                        <button className="write-btn" onClick={() => navigate("/community/write")}>
                            ‚úèÔ∏è Í∏ÄÏì∞Í∏∞
                        </button>
                    </div>

                    {/* ‚úÖ Î°úÎî©/ÏóêÎü¨/Îπà ÏÉÅÌÉú */}
                    {loading && <div className="post-list"><p>Î∂àÎü¨Ïò§Îäî Ï§ë‚Ä¶</p></div>}
                    {!loading && error && <div className="post-list"><p className="error">{error}</p></div>}
                    {!loading && !error && posts.length === 0 && (
                        <div className="post-list"><p>Í≤åÏãúÍ∏ÄÏù¥ ÏóÜÏäµÎãàÎã§.</p></div>
                    )}

                    {!loading && !error && posts.length > 0 && (
                        <div className="post-list">
                            {posts.map((post) => (
                                <div
                                    key={post.id}
                                    className="post-card"
                                    onClick={() => navigate(`/community/post/${post.id}`)}
                                    style={{ cursor: "pointer" }}
                                >
                                    <div className="post-meta">
                                        <div className="title-row">
                                            {post.status ? (
                                                <span className={`badge ${post.status === "Ìï¥Í≤∞Îê®" ? "badge-solved" : ""}`}>
                                                    {post.status}
                                                </span>
                                            ) : null}
                                            <h3 className="post-title">{post.title}</h3>
                                        </div>
                                        <p className="post-summary">{post.summary}</p>
                                    </div>
                                    <div className="post-tags">
                                        {(post.tags || []).map((tag, j) => (
                                            <span key={j} className="tag">{tag}</span>
                                        ))}
                                    </div>
                                    <div className="post-footer">
                                        <div className="post-footer-left">
                                            <span>{post.author}</span>
                                            <span>{post.date}</span>
                                        </div>
                                        <div className="post-footer-right">
                                            <span>üëç {post.likes}</span>
                                            <span>üí¨ {post.comments}</span>
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}

                    <div className="pagination-wrapper">
                        <div className="page-numbers">
                            <button className="page-button active">1</button>
                            <button className="page-button">2</button>
                            <button className="page-button">3</button>
                            <button className="page-button">4</button>
                            <button className="page-button">5</button>
                        </div>
                        <button className="next-page">Îã§Ïùå ÌéòÏù¥ÏßÄ</button>
                    </div>
                </main>

                <aside className="sidebar-right">
                    <div className="popular-tags">
                        <h4>Ïù∏Í∏∞ ÌÉúÍ∑∏</h4>
                        <div className="tag-list">
                            <span>Java</span><span>C</span><span>C++</span><span>jpa</span>
                            <span>JavaScript</span><span>Python</span><span>Í∞ùÏ≤¥ÏßÄÌñ•</span>
                            <span>ÎπÖÎç∞Ïù¥ÌÑ∞</span><span>spring</span><span>TypeScript</span><span>Î®∏Ïã†Îü¨Îãù</span>
                        </div>
                    </div>
                    <div className="popular-posts">
                        <h4>Ï£ºÍ∞Ñ Ïù∏Í∏∞Í∏Ä</h4>
                        <ul>
                            <li><div className="post-title">Î≤ÑÎ∏î Ï†ïÎ†¨ ÏãúÍ∞ÅÌôî ÌîÑÎ°úÏ†ùÌä∏ Í≥µÏú†Ìï©ÎãàÎã§</div><div className="post-author">ÍπÄÏΩîÎî©</div></li>
                            <li><div className="post-title">Í∑∏ÎûòÌîÑ ÌÉêÏÉâ ÏïåÍ≥†Î¶¨Ï¶ò ÎπÑÍµê: BFS vs DFS</div><div className="post-author">Ïù¥ÏïåÍ≥†</div></li>
                            <li><div className="post-title">ÎèôÏ†Å ÌîÑÎ°úÍ∑∏ÎûòÎ∞ç Î¨∏Ï†ú Ìï¥Í≤∞ Í∞ÄÏù¥Îìú</div><div className="post-author">Î∞ïÏΩîÎî©</div></li>
                            <li><div className="post-title">Î∞±ÏóîÎìú Ïã†ÏûÖ CS Ïä§ÌÑ∞Îîî 3Í∏∞ Î™®Ïßë</div><div className="post-author">ÍπÄÏßÄÌõà</div></li>
                            <li><div className="post-title">AI Ïã§Ï†Ñ ÌôúÏö©ÏùÑ ÏúÑÌïú 4Ï£º ÏßëÏ§ë Ïä§ÌÑ∞Îîî, Ïï†ÏÇ¨Î™®!</div><div className="post-author">Edun</div></li>
                        </ul>
                    </div>
                </aside>
            </div>
        </div>
    );
}
